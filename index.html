<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>vue</title>
    </head>
    <body>
        <div id="app">
            <span v-for="(vo,index) in list"></span>
            <input type="text" name="" v-if="show" v-model="val">
        </div>
        <script>
            (function(window){

                var count = 0;
                var Cache = {
                    setOption: function(uid,key,val){
                        Cache.uid[uid][key] = val;
                    },
                    getOption: function(uid,key){
                        return Cache.uid[uid][key];
                    },
                    uid: []
                };
                var todo = document.createComment("");
                var directives = {
                    "v-if": {
                        bind: function(vm,root,node){
                            this.vm = vm;
                            this.root = root;
                            this.node = node;
                        },
                        get: function(){
                            this.sent = this.node.getAttribute("v-if");
                            this.node.removeAttribute("v-if");
                            return this.sent !== null;
                        },
                        parse: function(){
                            var self = this;
                            self.vif = Vue.withOption.call(self.vm,"return "+self.sent);
                        },
                        insert: function(){
                            !this.vif && Vue.replaceNode(this.root,this.node,todo);
                        },
                        unbind: function(){
                            delete this.vm;
                            delete this.root;
                            delete this.node;
                        }
                    },
                    "v-model": {
                        bind: function(vm,root,node){
                            this.vm = vm;
                            this.root = root;
                            this.node = node;
                        },
                        get: function(){
                            this.sent = this.node.getAttribute("v-model");
                            this.node.removeAttribute("v-model");
                            return this.sent !== '';
                        },
                        parse: function(){
                            var self = this;
                            self.vmodel = Vue.withOption.call(self.vm,"return "+self.sent);
                        },
                        insert: function(){
                            var self = this;
                            this.node.value = self.vmodel;
                        },
                        unbind: function(){
                            delete this.vm;
                            delete this.root;
                            delete this.node;
                        }
                    },
                    "v-for": {
                        bind: function(vm,root,node){
                            this.vm = vm;
                            this.root = root;
                            this.node = node;
                        },
                        get: function(){
                            this.sent = this.node.getAttribute("v-for");
                            this.node.removeAttribute("v-for");
                            this.text = this.node.innerHTML;
                            return this.sent !== null;
                        },
                        parse: function(){
                            var self = this;
                            var sents = this.sent.replace(/\s+/g," ").split(" in ");
                            var left = sents[0].match(/[a-zA-z$_][a-zA-z$_0-9]+/g);//按变量规则取
                            var right = sents[1].match(/[a-zA-z$_][a-zA-z$_0-9]+/g);
                            self.vfor = Vue.withOption.call(self.vm,'with(obj){Vue.each('+right+',function('+left+'){obj.each.apply(obj,arguments)});}',true,self);
                        },
                        insert: function(){
                            var self = this;
                            var node;
                            self.each = function(index,vo){
                                node = self.node.cloneNode(true);
                                node.innerHTML = index;
                                Vue.insertNode(self.node.parentNode,self.node, node);
                            }
                            new Function('obj',self.vfor).bind(self.vm)(self);
                            Vue.removeNode(self.node.parentNode,self.node);
                        },
                        unbind: function(){
                            delete this.vm;
                            delete this.root;
                            delete this.node;
                        }
                    }
                }


                function Vue(option){
                    return new Vue.fn.init(option);
                }

                Vue.fn = Vue.prototype = {
                    constructor: Vue,
                    init: function(option){
                        //初始化option之前
                        option.beforeCreated && option.beforeCreated();
                        Vue.createUid.call(this);

                        if(option && option instanceof Object){
                            Cache.setOption(this.uid, 'option', option);
                            Vue.initOption.call(this,option);
                        }
                        option.created && option.created.call(this);
                        return this;
                    }
                }

                //使this继承source的属性
                //source[Object]: 来源
                //deep[Boolean]: 是否深拷贝
                //正序this属性将会被后者覆盖,如果不想this属性被覆盖,请对调this与source并赋值
                Vue.extend = Vue.fn.extend = function (source,deep){
                    var self = this;
                    for(var key in source){
                        if(deep && source[key] instanceof Object){
                            self[key] = Vue.extend.call({},source[key],deep);
                        }else{
                            self[key] = source[key];
                        }
                    }
                    return self;
                }

                //静态方法
                Vue.extend({
                    initOption: function(option){
                        if(option.el){
                            this.el = document.querySelector(option.el);
                        }
                        this.set(this,'data',{});
                        Vue.bindData.call(this,'data',option.data||{});

                        Vue.bindMethod.call(this,'methods',option.methods);

                        Vue.bindMethod.call(this,'filters',option.filters);

                        Vue.bindMethod.call(this,'computed',option.computed);

                        this.directives = directives;
                        Vue.parseTpl.call(this);
                    },

                    bindData: function (k,propertys){
                        var self = this;
                        var obj = self[k];
                        Vue.each(propertys,function(key,item){
                            self.set(obj, key, item);
                            //如果值为对象,继续绑定
                            if(item instanceof Object){
                                Vue.bindData.call(self, key, item);
                            }
                        });

                        // for(var k in propertys){
                        //     Vue.set(obj, k, propertys[k]);
                        //     //如果值为对象,继续绑定
                        //     if(propertys[k] instanceof Object){
                        //         Vue.bindData.call(obj, k,propertys[k]);
                        //     }
                        // }
                        return this;
                    },
                    //非function将被舍弃
                    bindMethod: function(k,methods){
                        var self = this;
                        self[k] = {};
                        Vue.each(methods,function(index,item){
                            if(item instanceof Function){
                                self.methods[index] = item;
                            }
                        })
                        // for(var k in methods){
                        //     if(methods[k] instanceof Function){
                        //         self.method[k] = methods[k];
                        //     }
                        // }
                        return this;
                    },
                    parseTpl: function(){
                        var self = this;
                        var data = self.data;
                        var dom = Cache.getOption(this.uid,'dom');
                        if(!dom){
                            dom = self.el.cloneNode(true);
                            Cache.setOption(this.uid, 'dom', dom);
                        }
                        var vnode = dom.cloneNode(true);
                        Vue.parseDirective.call(self,vnode,dom);
                        Vue.replaceNode(self.el.parentNode,self.el,vnode);
                        self.el = vnode;
                    },
                    //以dom为索引以vnode为模板
                    parseDirective: function(vnode,dom){
                        var self = this;
                        var list = [];
                        var dirs = this.directives;
                        var node,tpl;
                        Vue.each(dirs,function(key,dir){
                            for(var index=0,len = dom.childNodes.length;index<len;index++){
                                node = vnode.childNodes[index];
                                if(node && node.nodeType==1){
                                    dir.bind(self,vnode,node);
                                    if(dir.get()){
                                        dir.parse();
                                        dir.insert();
                                    }
                                    dir.unbind();
                                }
                            };
                        });
                        return this;
                    },
                    //注册指令
                    directive: function(dir,option){
                        var self = this;
                        var defaults = {
                            bind: function(){
                            },
                            get: function(){
                            },
                            parse: function(){
                            },
                            insert: function(){
                            },
                            unbind: function(){
                            }
                        };
                        option = Vue.extend.call(option,defaults);
                        this.directives = this.directives || {};
                        this.directives[dir] = option;
                    },

                    //返回字符串时可以继续加工
                    withOption: function(str,crude){
                        var fn = 'var methods = this.methods,data = this.data;with(window){with(methods){with(data){'+str+'}}}';
                        return crude ? fn :new Function(fn).bind(this)();
                    },
                    //设置双向绑定
                    //obj[Object]: 要绑定的对象
                    //propName[String]: 要绑定的属性
                    //value[Every]: 值
                    set: function(obj, propName, value) {
                        try {
                            Object.defineProperty(obj, propName, {
                                get: function() {
                                    return value;
                                },
                                set: function(newValue) {
                                    //value = newValue;
                                },
                                enumerable: true,
                                configurable: true
                            });
                        } catch (error) {
                            //console.log(error,"browser not supported.");
                        }
                    },
                    createUid: function(){
                        count = count || 1;
                        Cache.uid[count] = {};
                        this.uid = count++;
                        return this;
                    }
                });
                Vue.extend({
                    //替换节点
                    replaceNode: function(root,node,newNode){
                        //console.trace(arguments);
                        if(root){
                            root.insertBefore(newNode,node);
                            root.removeChild(node);
                        }
                        //return root.replaceChild(node,newNode);
                    },
                    //插入节点
                    insertNode: function(root,node,newNode){
                        if(root){
                            root.insertBefore(newNode,node);
                        }
                        //return root.replaceChild(node,newNode);
                    },
                    //插入节点
                    removeNode: function(root,node){
                        if(root){
                            root.removeChild(node);
                        }
                        //return root.replaceChild(node,newNode);
                    },
                    //获取元素及其innerHTML
                    html: function(node){
                        if(typeof node === 'string'){
                            return node;
                        }
                        var vnode = document.createElement('div');
                        vnode.appendChild(node.cloneNode(true));
                        return vnode.innerHTML;
                    },
                })
                //实例方法
                Vue.extend({
                    each: function(source,fn){
                        if(source instanceof Array || Vue.isArray(source)){
                            for(var i = 0,len = source.length;i < len;i++){
                                fn.call(source,i,source[i]);
                            }
                        }else if(source instanceof Object){
                            //var num = 0;
                            for(var k in source){
                                fn.call(source,k,source[k]);
                            }
                        }
                    },
                    isArray: function(o){
                        if(o && typeof o==="object"&& isFinite(o.length)){
                            if(o.length>=0 && o.length===Math.floor(o.length)&& o.length<4294967296){
                                return true;
                            }
                        }
                        return false;
                    }
                });

                //实例方法
                Vue.fn.extend({
                    set: function(obj, propName, value) {
                        var self = this;
                        if(obj!==undefined && propName!==undefined){
                            try {
                                Object.defineProperty(obj, propName, {
                                    get: function() {
                                        return value;
                                    },
                                    set: function(newValue) {
                                        value = newValue;
                                        Vue.parseTpl.call(self);
                                    },
                                    enumerable: true,
                                    configurable: true
                                });
                            } catch (error) {
                                console.log(error,self,arguments,"browser not supported.");
                            }
                        }
                    },
                });

                window.Vue = Vue;
                Vue.fn.init.prototype = Vue.prototype;

            })(window);

            window.onerror = function (msg, url, row, col, error) {
                console.log(arguments);
            }
        </script>
        <script>
            var a = new Vue({
                el:"#app",
                data: {
                    show: true,
                    val: "hello world",
                    list: [{index:1},{index:2},{index:3}]
                },
                methods: {
                    index: 4,
                    test: function(){
                        return this;
                    }
                },
                before: function(){

                },
                created: function(){

                }
            });
        </script>
    </body>
</html>
